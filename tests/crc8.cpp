#include <gtest/gtest.h>
#include <decup/decup.hpp>

// What the actual fuck? Out of order CRC8 calculation?
// Apparently the last value is the CV byte, the second to last the CRC...
TEST(crc8, write_cv) {
  decup::Packet packet{0x06u,  // Command
                       0xAAu,  // Security byte
                       0x00u,  // CV address
                       0x56u,  //
                       0x86u,  // CRC
                       0x7Cu}; // CV value
  uint8_t crc8{0x00u};
  crc8 = decup::crc8(crc8 ^ 0x56u);
  crc8 = decup::crc8(crc8 ^ 0x7Cu);
  crc8 = decup::crc8(crc8 ^ 0x86u);
  EXPECT_FALSE(crc8);
}

TEST(crc8, write_flash) {
  decup::Packet packet{
    0x05u, 0x55u, 0x02u, 0x2Au, 0x74u, 0x8Bu, 0x96u, 0x73u, 0x61u, 0x8Fu, 0xBBu,
    0xCCu, 0x92u, 0x42u, 0x53u, 0x84u, 0x92u, 0x75u, 0x3Du, 0x4Au, 0x92u, 0xA5u,
    0x98u, 0x6Du, 0x61u, 0x8Cu, 0x9Fu, 0x9Fu, 0x88u, 0x68u, 0x8Cu, 0xBAu, 0x9Eu,
    0x6Fu, 0x51u, 0x63u, 0x8Eu, 0x8Bu, 0x6Fu, 0x55u, 0x4Eu, 0x86u, 0xBBu, 0xA5u,
    0x7Eu, 0x5Eu, 0x75u, 0xACu, 0xACu, 0x75u, 0x49u, 0x52u, 0x9Cu, 0xBCu, 0x89u,
    0x4Au, 0x3Du, 0x84u, 0xC8u, 0xA1u, 0x5Bu, 0x52u, 0x82u, 0xC9u, 0xBDu, 0x6Bu,
    0x47u, 0x68u, 0xAAu, 0xB7u, 0x65u, 0x2Eu, 0x5Au, 0xACu, 0xD1u, 0x8Fu, 0x36u,
    0x42u, 0x8Au, 0xBFu, 0xAAu, 0x59u, 0x42u, 0x76u, 0xA3u, 0x9Fu, 0x66u, 0x43u,
    0x72u, 0xB0u, 0xBCu, 0x91u, 0x54u, 0x67u, 0xAEu, 0xBDu, 0x8Du, 0x60u, 0x5Fu,
    0x83u, 0x96u, 0x82u, 0x5Bu, 0x53u, 0x88u, 0xB7u, 0x9Fu, 0x68u, 0x4Cu, 0x6Fu,
    0xA9u, 0x98u, 0x5Au, 0x3Cu, 0x58u, 0xA0u, 0xBFu, 0x9Au, 0x6Bu, 0x5Cu, 0x82u,
    0xAFu, 0x9Bu, 0x81u, 0x84u, 0x98u, 0xAEu, 0x8Eu, 0x59u, 0x54u, 0x5Eu, 0x7Du,
    0x90u, 0x69u, 0x53u, 0x5Du, 0x7Fu, 0xB1u, 0xA1u, 0x7Bu, 0x8Au, 0x9Bu, 0xA5u,
    0x93u, 0x59u, 0x4Cu, 0x77u, 0x9Bu, 0xAAu, 0x66u, 0x32u, 0x65u, 0xA6u, 0xCAu,
    0xA2u, 0x4Eu, 0x58u, 0x93u, 0xADu, 0xA5u, 0x5Au, 0x34u, 0x7Cu, 0xB6u, 0xACu,
    0x65u, 0x28u, 0x6Du, 0xCAu, 0xC7u, 0x8Cu, 0x48u, 0x56u, 0xA6u, 0x9Fu, 0x62u,
    0x50u, 0x60u, 0xABu, 0xBFu, 0x73u, 0x3Au, 0x4Cu, 0x98u, 0xD8u, 0x95u, 0x4Cu,
    0x5Au, 0x8Bu, 0xCCu, 0xB8u, 0x4Cu, 0x47u, 0x8Au, 0xBAu, 0xC6u, 0x6Au, 0x2Cu,
    0x5Au, 0x7Du, 0x95u, 0x82u, 0x40u, 0x5Eu, 0x98u, 0xA9u, 0xB3u, 0x6Fu, 0x52u,
    0x9Cu, 0xBEu, 0xAEu, 0x72u, 0x34u, 0x68u, 0x9Fu, 0x90u, 0x79u, 0x4Au, 0x63u,
    0xBDu, 0xA9u, 0x71u, 0x55u, 0x56u, 0xA5u, 0xC7u, 0x92u, 0x7Eu, 0x6Du, 0x6Eu,
    0x93u, 0x6Du, 0x4Bu, 0x56u, 0x74u, 0xB7u, 0xC3u, 0x77u, 0x5Bu, 0x72u, 0xA0u,
    0xC9u, 0x85u, 0x43u, 0x63u, 0x89u, 0x93u, 0x77u, 0x47u, 0x68u, 0x99u, 0x96u,
    0x89u, 0x5Du, 0x60u, 0x9Fu, 0xB2u, 0x97u, 0x8Au, 0x9Au};
  EXPECT_FALSE(decup::crc8({cbegin(packet) + 2, cend(packet)}, 0x55u));
}
